#!/bin/bash

# Author: OuTiS

ORANGE=$(echo -ne '\e[38;5;214m')  
BLUE=$(echo -ne '\e[94m')           
RED=$(echo -ne '\e[31m')            
GREEN=$(echo -ne '\e[32m')          
ENDCOLOR=$(echo -ne '\e[0m')        
YELLOW=$(echo -ne '\033[0;33m')     
CYAN=$(echo -ne '\e[36m')           
MAGENTA=$(echo -ne '\e[35m')        
PURPLE=$(echo -ne '\e[38;5;129m') 

coredns_config_file="/etc/coREDns/Corefile"

check_user_root(){
    if [ "$EUID" -ne 0 ]; then 
        echo -e ""
        echo -e "${RED}This script must be run as root. Please switch to the root user and try again.${ENDCOLOR}"
        exit 1
    fi
}

clear
check_user_root
sleep 1;

kill_port() {
    PID=$(lsof -t -i:53)
    if [ -n "$PID" ]; then
        kill -9 $PID
    fi
}

ZONE_DIR="/etc/coREDns/zones"
COREFILE="/etc/coREDns/Corefile"
COREDNS_SERVICE="coredns"
LOG_FILE="/var/log/coREDns_manager.log"

install_coREDns(){
    clear 
    sleep .5 
    echo -e "${BLUE}Checking operating system...${ENDCOLOR}"
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        if [[ $ID != "ubuntu" ]]; then
            echo -e "${RED}This script only supports Ubuntu. Detected OS: $ID.${ENDCOLOR}"
            exit 1
        fi
    else
        echo -e "${RED}Cannot detect the operating system! Exiting.${ENDCOLOR}"
        exit 1
    fi

    echo -e "${BLUE}Installing CoreDNS on Ubuntu...${ENDCOLOR}"
    clear 
    sleep .5 
    apt update -y 2>/dev/null
    apt install -y curl sshpass tar wget 2>/dev/null
    sleep 1
    clear

    COREDNS_VERSION=$(curl -s https://github.com/coredns/coredns/releases | grep -oP '(?<=/coredns/coredns/releases/tag/v)[0-9]+\.[0-9]+\.[0-9]+' | head -1)

    if [[ -z "$COREDNS_VERSION" ]]; then
        echo -e "${RED}Failed to fetch the latest CoreDNS version.${ENDCOLOR}"
        exit 1
    fi

    echo -e "${BLUE}Latest CoreDNS version: ${COREDNS_VERSION}${ENDCOLOR}"
    echo -e "${BLUE}Downloading CoreDNS...${ENDCOLOR}"

    wget "https://github.com/coREDns/coREDns/releases/download/v${COREDNS_VERSION}/coredns_${COREDNS_VERSION}_linux_amd64.tgz" -O /tmp/coredns.tgz

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}Failed to download CoreDNS.${ENDCOLOR}"
        exit 1
    fi

    tar -xzf /tmp/coredns.tgz
    mv /tmp/coredns /usr/local/bin/
    rm -f /tmp/coredns.tgz
    kill_port
}

service_coREDns(){
    cat <<EOL > /etc/systemd/system/coredns.service
[Unit]
Description=CoreDNS DNS server
Documentation=https://coREDns.io
After=network.target

[Service]
ExecStart=/usr/local/bin/coredns -conf /etc/coREDns/Corefile
Restart=on-failure
User=root

[Install]
WantedBy=multi-user.target
EOL

    echo -e "${BLUE}Enabling and starting CoreDNS service...${ENDCOLOR}"
    systemctl daemon-reload
    systemctl enable coredns
    systemctl start coredns

    if systemctl is-active --quiet coredns; then
        echo -e "${GREEN}CoreDNS installed and running successfully.${ENDCOLOR}"
    else
        echo -e "${RED}CoreDNS installation failed or the service is not running.${ENDCOLOR}"
    fi
}

add_domain() {
    read -p "$(echo -e "${BLUE} Enter the domain name:  ${ENDCOLOR}")" domain
    read -p "$(echo -e "${BLUE} Enter the IP for the domain:  ${ENDCOLOR}")" ip 

    if ! [[ $domain =~ ^[a-zA-Z0-9.-]+$ ]]; then
        echo -e "${RED}Invalid domain name.${ENDCOLOR}"
        return
    fi

    if ! [[ $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ || $ip =~ : ]]; then
        echo -e "${RED}Invalid IP address.${ENDCOLOR}"
        return
    fi

    zone_file="$ZONE_DIR/db.$domain"
    if [[ -f "$zone_file" ]]; then
        echo -e "${RED}Domain already exists.${ENDCOLOR}"
        return
    fi

    mkdir -p "$ZONE_DIR"
    cat <<EOL > "$zone_file"
\$TTL 3600
@       IN      SOA     ns1.$domain. admin.$domain. (
                        $(date +%Y%m%d%H)
                        3600
                        1800
                        604800
                        86400 )
@        IN      NS      ns1.$domain.
@        IN      NS      ns2.$domain.
ns1     IN      A       $ip
ns2     IN      A       $ip
@       IN      A       $ip
www     IN      A       $ip
EOL

    if [[ $ip =~ : ]]; then
        echo "ns1     IN    AAAA    $ip" >> "$zone_file"
        echo "ns2     IN    AAAA    $ip" >> "$zone_file"
    fi
    if [[ ! -f "$COREFILE" ]]; then
    echo -e "${YELLOW}Corefile not found. Creating a new one.${ENDCOLOR}"
    cat << EOF > "$COREFILE"
.:53 {
    log
    errors
    cache 600
    file "$ZONE_DIR/db.$domain"
}

zone "$domain" {
    file "$ZONE_DIR/db.$domain"
}
EOF
fi

    systemctl restart coredns
}

add_record() {
  read -p "$(echo -e "${BLUE} Enter the domain name:  ${ENDCOLOR}")" domain
  zone_file="$ZONE_DIR/db.$domain"

  if [[ ! -f "$zone_file" ]]; then
    echo -e "${RED}Domain does not exist.${ENDCOLOR}"
    return
  fi

  read -p "${BLUE}Enter the record type (A, CNAME, MX, ...): ${ENDCOLOR}" type
  read -p "${BLUE}Enter the record name: ${ENDCOLOR}" name
  read -p "${BLUE}Enter the record value: ${ENDCOLOR}" value

  if [[ "$type" == "MX" ]]; then
    if [[ ! "$value" =~ \.$ ]]; then
      value="$value."
    fi
    value="10 $value"
  fi

  echo "$name    IN    $type    $value" >> "$zone_file"
  echo -e "${GREEN}Record added successfully.${ENDCOLOR}"
  echo "$(date) - Added record: $name $type $value to $domain" >> "$LOG_FILE"
}

remove_record() {
    read -p "$(echo -e "${BLUE} Enter the domain name: ${ENDCOLOR}")" domain
    zone_file="$ZONE_DIR/db.$domain"

    if [[ ! -f "$zone_file" ]]; then
        echo -e "${RED}Domain does not exist.${ENDCOLOR}"
        return
    fi

    echo -e "${YELLOW}Current records:${ENDCOLOR}"
    cat "$zone_file"

    read -p "$(echo -e "${BLUE} Enter the record to remove (full line): ${ENDCOLOR}")" record
    sed -i "/$record/d" "$zone_file"
    echo -e "${GREEN}Record removed successfully.${ENDCOLOR}"
    echo "$(date) - Removed record: $record from $domain" >> "$LOG_FILE"
    systemctl  restart  coredns
}

ZONE_DIR="/etc/coREDns/zones/"
valid_file_db() {
    clear 
  for zone_file in "$ZONE_DIR"/db.*; do
    if [[ -f "$zone_file" ]]; then
      domain=$(echo "$zone_file" | cut -d"." -f 2,3)

      if named-checkzone "$domain" "$zone_file" ; then
        echo -e "${BLUE}$domain ${ENDCOLOR} ${GREEN}: Ok .${ENDCOLOR}\n"
        echo -e "------------------"
      else
        echo -e "${RED}$domain: Not Ok!${ENDCOLOR}\n"
      fi
    else
      echo -e "${RED}File $zone_file not found!${ENDCOLOR}"
    fi
  done
}

list_domains() {
    echo -e "${GREEN}Available domains:${ENDCOLOR}"
    domains=$(grep "zone" "$COREFILE" | awk '{print $2}' | tr -d '\";')

    if [[ -z "$domains" ]]; then
        echo -e "${RED}No domains found in CoreDNS configuration.${ENDCOLOR}"
        return
    fi

    echo -e "${GREEN}Please choose a domain from the list below:${ENDCOLOR}"
    echo "$domains"
    
    read -p "$(echo -e "${BLUE} Enter the domain name to get the name servers:  ${ENDCOLOR}")" domain
    if ! echo "$domains" | grep -w "$domain" &>/dev/null; then
        echo -e "${RED}Domain not found in the list.${ENDCOLOR}"
        return
    fi

    echo -e "${BLUE}For domain $domain, please set the following name servers in your domain management panel:${ENDCOLOR}"
    echo -e "ns1.$domain"
    echo -e "ns2.$domain"
    echo -e "${GREEN}Please make sure to set the above name servers in the DNS settings of your domain.${ENDCOLOR}"
}

reload_coREDns() {
    systemctl restart "$COREDNS_SERVICE"
    echo -e "${GREEN}CoreDNS reloaded successfully.${ENDCOLOR}"
    echo "$(date) - Reloaded CoreDNS" >> "$LOG_FILE"
}

backup_zones() {
    backup_file="/etc/coREDns/zones_backup_$(date +%Y%m%d%H%M%S).tar.gz"
    tar -czf "$backup_file" "$ZONE_DIR"
    echo -e "${GREEN}Backup created at $backup_file${ENDCOLOR}"
    echo "$(date) - Created backup: $backup_file" >> "$LOG_FILE"
}

restore_zones() {
    read -p "$(echo -e "${BLUE} Enter the backup file path: ${ENDCOLOR}")" backup_file
    if [[ -f "$backup_file" ]]; then
        tar -xzf "$backup_file" -C /
        echo -e "${GREEN}Zones restoRED successfully.${ENDCOLOR}"
        echo "$(date) - RestoRED backup: $backup_file" >> "$LOG_FILE"
    else
        echo -e "${RED}Backup file not found.${ENDCOLOR}"
    fi
}

add_config_to_coredns() {

    coredns_config_file="/etc/coREDns/Corefile" 
    
    if [[ -z "$coredns_config_file" || ! -f "$coredns_config_file" ]]; then
        echo -e "${RED}CoreDNS config file not found at $coredns_config_file${ENDCOLOR}"
        return 1
    fi
    awk -v geoip_config="# GeoIP configuration for CoreDNS\ngeoip /etc/coREDns/geoip/GeoCountry.mmdb {\n    country yes\n}" '
        /cache 600/ { print; print geoip_config; next }
        { print }
    ' "$coredns_config_file" > "$coredns_config_file.new" && mv "$coredns_config_file.new" "$coredns_config_file"

    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}GeoIP configuration added successfully to $coredns_config_file${ENDCOLOR}"
    else
        echo -e "${RED}Failed to update $coredns_config_file${ENDCOLOR}"
        return 1
    fi
}

set_geoip() {
    sleep 0.5 
    clear 
    local geoip_dir="/etc/coREDns/geoip"
    local geoip_file="GeoCountry.mmdb"

    if [[ -f "$geoip_file" ]]; then
        echo -e "${MAGENTA}GeoIP database found in the project root, copying to $geoip_dir...${ENDCOLOR}"

        mkdir -p "$geoip_dir"
        
        rsync --progress "$geoip_file" "$geoip_dir/"
        
        if [[ $? -ne 0 ]]; then
            echo -e "${RED}Failed to copy GeoIP database.${ENDCOLOR}"
            return 1
        fi

        add_config_to_coredns

        echo -e "${GREEN}GeoIP database copied successfully!${ENDCOLOR}"
    else
        echo -e "${RED}GeoIP database not found in the project root.${ENDCOLOR}"
        return 1
    fi
}

add_country_to_coredns() {
    
    echo "Enter the country code (e.g., IR for Iran): "
    read country_code
    echo "Enter the destination IP for $country_code: "
    read destination_ip

    if [[ -z "$country_code" || -z "$destination_ip" ]]; then
        echo "Country code and destination IP cannot be empty!"
        return 1
    fi

    local geoip_position=$(awk '/# GeoIP configuration for CoreDNS/ {print NR}' "$coredns_config_file")
    
    if [[ -z "$geoip_position" ]]; then
        echo "GeoIP section not found. Adding the new country settings at the end."
        geoip_position=$(wc -l < "$coredns_config_file")  
    fi

    echo -e "\n# Country-based forwarding for $country_code" >> "$coredns_config_file"
    echo "country \"$country_code\" {" >> "$coredns_config_file"
    echo "    forward . $destination_ip" >> "$coredns_config_file"
    echo "}" >> "$coredns_config_file"
    
    echo "Country-based forwarding for $country_code added successfully."
}

node2(){

    clear 
    echo -e "${CYAN}Please enter the details for the second server.${ENDCOLOR}"
    read -p "$(echo -e ${YELLOW}Enter the second server IP : ${ENDCOLOR})" SECONDARY_DNS_IP
    read -p "$(echo -e ${YELLOW}Enter the SSH username for the second server: ${ENDCOLOR})" SSH_USER
    read -s -p "$(echo -e ${YELLOW}Enter the SSH password: ${ENDCOLOR})" SSH_PASS
    echo ""
    
    echo -e "${MAGENTA} Setting up second server ($SECONDARY_DNS_IP)...${ENDCOLOR}"

    sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@$SECONDARY_DNS_IP <<EOF
   curl -sLO https://raw.githubusercontent.com/Guilt92/NameShift/main/run
   printf "1\n" | sudo bash run
EOF

}

while true; do
    sleep 0.6 
    clear 
    echo " "
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${ENDCOLOR}"
    echo -e "                    ${GREEN} ðŸ”¥ NameShift ðŸ”¥   ${ENDCOLOR}"
    echo -e "                 ${CYAN} https://github.com/Guilt92  ${ENDCOLOR}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${ENDCOLOR}"
    echo " "
    echo -e "${RED}============================ ${ENDCOLOR}"
    echo -e "${RED}1.${ENDCOLOR}  Installing NameShift ${ENDCOLOR}"
    echo -e "${RED}2.${ENDCOLOR}  Add a new domain${ENDCOLOR}"
    echo -e "${RED}3.${ENDCOLOR}  Multi Server${ENDCOLOR}"
    echo -e "${RED}4.${ENDCOLOR}  Add a DNS record${ENDCOLOR}"
    echo -e "${RED}5.${ENDCOLOR}  Remove a DNS record${ENDCOLOR}"
    echo -e "${RED}6.${ENDCOLOR}  List all domains${ENDCOLOR}"
    echo -e "${RED}7.${ENDCOLOR}  Reload CoreDNS${ENDCOLOR}"
    echo -e "${RED}8.${ENDCOLOR}  Backup zones${ENDCOLOR}"
    echo -e "${RED}9.${ENDCOLOR}  Restore zones${ENDCOLOR}"
    echo -e "${RED}10.${ENDCOLOR} Check Format Db Domains ${ENDCOLOR}"
    echo -e "${RED}11.${ENDCOLOR} Add GeoIP  ${ENDCOLOR}"
    echo -e "${RED}12.${ENDCOLOR} Add Country To GeoIP${ENDCOLOR}"
    echo -e "${RED}13.${ENDCOLOR} Exit${ENDCOLOR}"
    echo -e "${RED}============================ ${ENDCOLOR}"
    echo " "

    read -p "$(echo -e "${BLUE} Choose an option: ${ENDCOLOR}")" choice

    case $choice in
        1) install_coREDns ; sleep 1; reload_coREDns ;;
        2) add_domain ; sleep 1 ;  service_coREDns;;
        3) multi ; sleep 2 ;  exit;;
        4) add_record ;;
        5) remove_record ;;
        6) list_domains ;;
        7) reload_coREDns ;;
        8) backup_zones ;;
        9) restore_zones ;;
        10) valid_file_db;;
        11) set_geoip ; sleep 1 ; reload_coREDns ;;
        12) add_country_to_coredns ; sleep 1 ; reload_coREDns ;;
        13) exit ;;
        *) echo -e "${RED}Invalid option. Please try again.${ENDCOLOR}" ; sleep 1.5 ;;
    esac

    read -p "$(echo -e "${BLUE}Press Enter to continue... ${ENDCOLOR}")" key
done
